---
- name: create volume-dirs
  file:
    path: "/volumes/activemq/{{item}}"
    state: directory
  with_items:
  - config
  - lib

- name: copy (template) conf to host
  template:
    src: "{{item}}.j2"
    dest: "/volumes/activemq/config/{{item}}"
  with_items:
  - activemq.xml
  - log4j.properties
  - jmx.password

- name: copy conf to host
  copy:
    src: "{{item}}"
    dest: "/volumes/activemq/config/{{item}}"
  with_items:
  - keystore.jks
  - login.config
  - users.properties
  - cert_users.properties
  - groups.properties

- name: copy activemq-plugin
  copy:
    src: "../kalinka-activemq-plugin/target/kalinka-activemq-plugin-{{activemq_plugin_version}}.jar"
    dest: /volumes/activemq/lib/kalinka-activemq-plugin.jar

- name: start container
  docker_container:
    name: activemq
    image: "rmohr/activemq:{{activemq_version}}" 
    docker_host: "{{docker_host}}"
    network_mode: host
    state: "{{activemq_state}}"
    recreate: "{{activemq_reset or reset_all}}"
    restart: "{{activemq_restart}}"
    restart_policy: unless-stopped
    volumes:
    - /volumes/activemq/config/log4j.properties:/opt/activemq/conf/log4j.properties
    - /volumes/activemq/config/activemq.xml:/opt/activemq/conf/activemq.xml
    - /volumes/activemq/config/jmx.password:/opt/activemq/conf/jmx.password
    - /volumes/activemq/lib/kalinka-activemq-plugin.jar:/opt/activemq/lib/kalinka-activemq-plugin.jar
    - /volumes/activemq/config/keystore.jks:/opt/activemq/conf/keystore.jks
    - /volumes/activemq/config/login.config:/opt/activemq/conf/login.config
    - /volumes/activemq/config/users.properties:/opt/activemq/conf/users.properties
    - /volumes/activemq/config/cert_users.properties:/opt/activemq/conf/cert_users.properties
    - /volumes/activemq/config/groups.properties:/opt/activemq/conf/groups.properties

